#!/usr/bin/env node

const fs = require("fs/promises");
const path = require("path");

(async () => {
    const srcDir = path.join(__dirname, "../src");
    const assetsDir = path.join(srcDir, "assets");
    const imagesDir = path.join(assetsDir, "images");

    const imagesDirContent = await fs.readdir(imagesDir);

    let imports = "";
    let loads = "";

    imagesDirContent.forEach((file) => {
        const varName = file.replace(/[-\.]/g, "");
        imports += `import ${varName} from './assets/images/${file}';\n`;
        loads += `\n\t\t(() => new Promise((resolve) => {const ${varName}Image = new Image();${varName}Image.onload = resolve;${varName}Image.src = ${varName};}))(),`;
    });

    await fs.writeFile(path.join(srcDir, "preload.js"), "// This file is autogenerated\n\n" + imports + "\nfunction preload() {\n\treturn Promise.all([" + loads + "\n\t]);\n}\n\nexport default preload;");
})();